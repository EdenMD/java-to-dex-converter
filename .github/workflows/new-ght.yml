name: Java to DEX Conversion

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build-dex:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK (for d8 tool)
      run: |
        SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$SDK_ROOT/cmdline-tools"
        
        # Download Command Line Tools (latest version available via Google's URL)
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8509387_latest.zip -O cmdline-tools.zip
        
        # Unzip into a temporary directory, then move contents to the correct 'latest' structure
        mkdir -p "$SDK_ROOT/cmdline-tools/temp"
        unzip -q cmdline-tools.zip -d "$SDK_ROOT/cmdline-tools/temp"
        
        # The zip contains a 'cmdline-tools' directory at the root. We need its *contents*.
        mv "$SDK_ROOT/cmdline-tools/temp/cmdline-tools"/* "$SDK_ROOT/cmdline-tools/"
        rmdir "$SDK_ROOT/cmdline-tools/temp/cmdline-tools"
        rmdir "$SDK_ROOT/cmdline-tools/temp"
        
        # Create the 'latest' symlink/directory structure as sdkmanager expects
        mkdir -p "$SDK_ROOT/cmdline-tools/latest"
        mv "$SDK_ROOT/cmdline-tools/bin" "$SDK_ROOT/cmdline-tools/latest/"
        mv "$SDK_ROOT/cmdline-tools/lib" "$SDK_ROOT/cmdline-tools/latest/"
        mv "$SDK_ROOT/cmdline-tools/source.properties" "$SDK_ROOT/cmdline-tools/latest/"
        
        export ANDROID_HOME="$SDK_ROOT"
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
        
        # Accept Android SDK licenses (this might fail if the path is not perfectly right)
        yes | sdkmanager --licenses
        
        # Install Android Build Tools (e.g., version 34.0.0, you can change this)
        sdkmanager "build-tools;34.0.0"
        
        # Add build-tools to PATH for d8 to be found
        export PATH="$ANDROID_HOME/build-tools/34.0.0:$PATH"
        
        echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
        echo "PATH=$PATH" >> "$GITHUB_ENV"

    - name: Compile Java classes
      run: |
        mkdir -p build/classes
        find src -name "*.java" | xargs javac -d build/classes

    - name: Convert compiled Java classes to DEX
      run: |
        mkdir -p build/dex
        d8 build/classes --output build/dex/output.dex

    - name: Upload DEX files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: java-to-dex-output
        path: build/dex/output.dex