name: Java to DEX Conversion

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-dex:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK (for d8 tool)
      run: |
        SDK_ROOT="$HOME/android-sdk"
        mkdir -p "$SDK_ROOT"
        
        # Install Command Line Tools (latest version available via Google's URL)
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-8509387_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d "$SDK_ROOT/cmdline-tools"
        # The unzip creates a 'cmdline-tools' directory inside the destination, we need to correct its structure
        mv "$SDK_ROOT/cmdline-tools/cmdline-tools" "$SDK_ROOT/cmdline-tools/latest"
        
        export ANDROID_HOME="$SDK_ROOT"
        export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
        
        # Accept Android SDK licenses
        yes | sdkmanager --licenses
        
        # Install Android Build Tools (e.g., version 34.0.0, you can change this)
        # This provides the 'd8' command.
        sdkmanager "build-tools;34.0.0"
        
        # Add build-tools to PATH for d8 to be found
        export PATH="$ANDROID_HOME/build-tools/34.0.0:$PATH"
        
        echo "ANDROID_HOME=$ANDROID_HOME" >> "$GITHUB_ENV"
        echo "PATH=$PATH" >> "$GITHUB_ENV" # Make PATH changes persistent for subsequent steps

    - name: Compile Java classes
      # This assumes your Java source files are in a directory named 'src/'.
      # E.g., src/com/example/MyClass.java
      # It compiles them to 'build/classes'.
      run: |
        mkdir -p build/classes
        find src -name "*.java" | xargs javac -d build/classes

    - name: Convert compiled Java classes to DEX
      run: |
        mkdir -p build/dex
        # d8 takes .class files or .jar files and outputs a .dex file
        d8 build/classes --output build/dex/output.dex
        # If you have external library .jar files you need to include in the DEX,
        # you would add them like: d8 build/classes path/to/your/libs/*.jar --output build/dex/output.dex

    - name: Upload DEX files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: java-to-dex-output
        path: build/dex/output.dex
        # If d8 outputs multiple .dex files (e.g., for very large projects), you might
        # want to upload the entire directory: path: build/dex/